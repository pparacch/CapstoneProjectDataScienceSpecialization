---
title: 'Models: Comparing & Evaluation'
author: "Pier Lorenzo Paracchini"
date: "10 mai 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(knitr)

# WINDOWS LOCALE SETTING
Sys.setlocale(category = "LC_ALL",locale = "English_United States.1252")

```

# Testing

A simple approach for testing the different models is to evaluate  __How does our language model prefer good sentences over bad one?__, or in other words __Does the model assign high probability to "real" or "frequently observed" sentences?__.

The test is done using a set of sentences that have not been used for training the model - basic assumption __the model has never seen those sentences__.

The evaluation metrics (ln scale) used to evaluate how well the model is preforming in the __P(S)__ (probability assigned to the sentence S = w1, w2, .., wn) and perplexity. These metrics are related __perplexity = f(probability)__. A better model is the one which assigns a higher probability to the words that actually occurs (reality).

```{r creatingTestDataSetOfSentences}
sentences <- c(
    #High Probability (max is ln(1) = 0/ Lower perplexity (limit to 0 when ln(1))
    "<s> you will absolutely love it </s>",
    "<s> you will absolutely love him after the meeting </s>",
    "<s> if this isn't the cutest thing you've ever seen then you must be insane </s>",
    "<s> i think most people mean things like that </s>",
    "<s> morning is my least favorite time of the day </s>",
    "<s> i love you </s>",
    
    #Lower Probability/ Higher perplexity
    "<s> you will absolutely love and it </s>",
    "<s> you will absolutely love him after the and meeting </s>",
    "<s> you will absolutely him after the meeting </s>",
    "<s> if this isn't not the cutest thing you've ever never seen then you must be insane </s>",
    "<s> i think most people mean things like that </s>",
    "<s> i love you not </s>"
)
```

# Tri-gram model based on MLE, using all of the trigrams and bigrams within all of the sample corpus, No smoothing

The trigrams and bigrams generated using all of the sample corpora are used. If the combination bigram, net word is not found the model assign a 0 probability to that specific case.

```{r loadTheModel, cache = T}
#Model - based on all of the 3g and 2g from the all corpora used for training
#Model - simple MLE / no smoothing applied
load(file = "./../scripts/model_trigramLanguage/allCorpora.3gModel_i_2016-05-10.rdata")
```

# Based on MLE, using all of the trigrams and bigrams within all of the sample corpus, no smoothing

```{r testTrigramModel_3g_all_2g_all_MLE_model, collapse = T}
source("./../scripts/model.R")
source("./../scripts/model_trigramLanguageModel.R")

#Size of the object in memory
format(object.size(data.3g.model.df), "auto")

# estimateSentenceProbabilities.mle(paste("<s>", sentences[1], "</s>"), data.3g.model.df)
data.3g.model.evaluation <- sapply(sentences, FUN = estimateSentenceProbabilities.mle, data.3g.model.df)
colnames(data.3g.model.evaluation) <- NULL
data.3g.model.evaluation <- t(data.3g.model.evaluation)
model1.perplexity <- calculatePerplexity(data.3g.model.evaluation)
```

`r kable(data.3g.model.evaluation, caption = "Tri-grams Model - Base")`

__Perplexity (log base2):__ `r model1.perplexity`

```{r cleanUp}
rm(data.2g, data.3g, data.3g.model, data.3g.model.df, data.3g.model.evaluation)
```

## Simplified Trigrams Model with (simple) Good-Turing Smoothing

```{r loadData_model1_1, cache = T}
load("./../data/processed/04_s01_allCorpora_aggregated_termsFrequency.3g.rdata")
allSample.termFreq.3g <- d.ng.df
d.ng.df <- NULL
```


```{r evaluate_model1_1, collapse = T}
source("./../scripts/model.R")

model1_1.evaluation <- sapply(sentences, 
                              FUN = estimateSentenceProbabilities.ng.model.simple.withGoodTuring.smoothing, 
                              terms = allSample.termFreq.3g$terms, counters = allSample.termFreq.3g$total, ng = 3)
colnames(model1_1.evaluation) <- NULL
model1_1.evaluation <- t(model1_1.evaluation)
model1_1.perplexity <- calculatePerplexity(model1_1.evaluation)
```

`r kable(model1_1.evaluation, caption = "Tri-grams Model - Base")`

__Perplexity (log base2):__ `r model1_1.perplexity`


## Simplified Bigrams Model with (simple) Good-Turing Smoothing

```{r loadData_model2, cache = T}
load("./../data/processed/04_s01_allCorpora_aggregated_termsFrequency.2g.rdata")
allSample.termFreq.2g <- d.ng.df
d.ng.df <- NULL
```


```{r evaluate_model2, collapse = T}
source("./../scripts/model.R")

model2.evaluation <- sapply(sentences, 
                              FUN = estimateSentenceProbabilities.ng.model.simple.withGoodTuring.smoothing, 
                              terms = allSample.termFreq.2g$terms, counters = allSample.termFreq.2g$total, ng = 2)
colnames(model2.evaluation) <- NULL
model2.evaluation <- t(model2.evaluation)
model2.perplexity <- calculatePerplexity(model2.evaluation)
```

`r kable(model2.evaluation, caption = "Bi-grams Model - Base")`

__Perplexity (log base2):__ `r model2.perplexity`


# Tri-gram model based on Stupid Backoff, using all of the trigrams and bigrams within all of the sample corpus

The trigrams and bigrams generated using all of the sample corpora are used. If the combination bigram, net word is not found the model assign a 0 probability to that specific case.

```{r loadTheModelData, cache = T, collapse=T}
load("./../scripts/model_stupidBackoff_3g_Language/04_s01_allCorpora_aggregated_termsFrequency.3g.rdata")
allCorpora.3g <- d.ng.df
d.ng.df <- NULL

load("./../scripts/model_stupidBackoff_3g_Language/04_s01_allCorpora_aggregated_termsFrequency.2g.rdata")
allCorpora.2g <- d.ng.df
d.ng.df <- NULL

load("./../scripts/model_stupidBackoff_3g_Language/04_s01_allCorpora_aggregated_termsFrequency.1g.rdata")
allCorpora.1g <- d.ng.df
d.ng.df <- NULL

#Size of the object in memory
format(object.size(allCorpora.3g$terms), "auto")
format(object.size(allCorpora.3g$total), "auto")

format(object.size(allCorpora.2g$terms), "auto")
format(object.size(allCorpora.2g$total), "auto")

format(object.size(allCorpora.1g$terms), "auto")
format(object.size(allCorpora.1g$total), "auto")
```

```{r testStupidBackOff_3g_all_2g_all_1g_all_model, collapse=T}
stupidBackoff.model.base.evaluation <- sapply(sentences, FUN = estimateSentenceProbabilities,
                                   t.terms = allCorpora.3g$terms, t.counters = allCorpora.3g$total,
                                   b.terms = allCorpora.2g$terms, allCorpora.2g$total,
                                   u.words = allCorpora.1g$terms, u.counters = allCorpora.1g$total)
colnames(stupidBackoff.model.base.evaluation) <- NULL
stupidBackoff.model.base.evaluation <- t(stupidBackoff.model.base.evaluation)
model3.perplexity <- calculatePerplexity(stupidBackoff.model.base.evaluation)
```

`r kable(stupidBackoff.model.base.evaluation, caption = "Tri-grams StupidBackoff - simple")`

__Perplexity (log base2):__ `r model3.perplexity`


Model | Perplexity
------------- | -------------
Trigram - no smoothing - all corpora| `r model1.perplexity`
Trigram - GT smoothing - allCorpora | `r model1_1.perplexity`
Bigram - GT smoothing - allCorpora | `r model2.perplexity`
StupidBackoff - no smoothing - allCorpora | `r model3.perplexity`

